+++
author = "coucou"
title = "单片机 笔记"
date = "2022-05-01"
description = "单片机散知识"
tags = [
    "单片机"
]
+++

## 单片机

### 1. 输入输出以及复用模式

#### 1.1 输入

（1）输入上拉：默认输入高电平

（2）输入下拉：默认输入低电平

（3）浮空输入：不稳定

（4）模拟输入：如AD模拟信号

#### 1.2输出

（1）推挽输出：P-MOS和N-MOS均有效，高低电平均有较强驱动能力

（2）开漏输出：N-MOS有效，低电平有较强的驱动能力

​																										补充：TTL 是斯密特触发器：防止信号不稳定	

### 2. 初始化过程

（1）使能IO口时钟

（2）初始化IO口模式

（3）操作IO

### 3. 通信

|  形式  |         IO口         |     方式     |
| :----: | :------------------: | :----------: |
|  UART  |       TXD，RXD       | 全双工，异步 |
|  I2C   |       SCL，SDA       | 半双工，同步 |
|  SPI   | SCLK，MOSI，MISO，CS | 全双工，同步 |
| 1-wire |          DQ          | 半双工，异步 |

（1）全双工：同一时刻可互传数据

（2）半双工：同一时刻不可互传数据

（3）同步：双方靠一根时钟线来约定通信速率

（4）异步：双方各自约定通信速率 

### 4. 单片机使用printf()

> 使用之前，一定要将配置里的【use microlLIB】选项卡勾上！不然用不了！！

```c
#include "stdio.h"

int fputc(int ch, FILE *f)
{ 	
	while((USART1->SR & 0X40)==0);//循环发送,直到发送完毕   
	USART1->DR = (u8) ch;      
	return ch;
}
```

### 5. PWM和占空比

> **PWM**
>
> ***应用方法：***就是控制在一个周期内，控制高电平多长时间，低电平多长时间，在数字电路中IO口就只有两种状态，**0和1(高低)，对应就是0和5V或者0和3.3V）。也就是说，通过调节高低电平时间的变化来调节信号、能量等的变化**
>
> **占空比**
> 是指 ***高电平持续*** **时间** ***比*** 一个 ***周期持续*** 的**时间**。
> 所以可以通过控制占空比，来控制输出的等效电压。所以对于方波的话，频率和占空比就确定了一个波

### 6. 输入捕获

> 输入捕获模式可以用来测量脉冲宽度或者测量频率，下图以测量脉宽为例来说明输入捕获的原理
>
> ![](https://s2.51cto.com/images/blog/202112/25035502_61c62596e68ec69920.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=)
>
> 假定定时器工作在向上计数模式，图中t1-t2的时间就是我们需要测量的低电平时间。测量方法为：首先设置定时器通道x为下降沿捕获，在t1时刻就会捕获到当前的CNT值，然后立即清零CNT，并设置通道x为上升沿捕获，到t2时刻又会发送捕获事件，得到此时的CNT值（记为CCRx2）。在t1-t2之间可能产生N次定时器溢出，因此需要对定时器溢出做处理，防止低电平太长导致数据不准确。
> t1-t2之间计数的次数为：N * ARR + CCRx2，再乘以CNT计数周期即可得到低电平持续时间
> -----------------------------------

### 7. 定时器时间计算

#### 7.1 单片机的定时原理

通过每一个机器周期，就加一，通过数1的方式进行计时。

#### 7.2 基本概念

1.晶振：又称晶体振荡器，是数字电路“心脏”，是电子元件中不可或缺的频率元件，对于数字电路系统，晶振的好还直接影响系统的稳定性。

2.时钟周期：将晶振的频率的倒数定义为时钟周期，在一个时钟周期内，CPU完成一个基础动作，对于更小的时钟周期，意味着CPU有更好的性能，更高的工作效率。

3.机器周期：将时钟周期的6倍或者12倍定义为一个机器周期，具体的设定需要通过人为进行控制

#### 7.3 每一次“加1”经过的时间是多少

当晶振频率是11.0592MHz的时候，等于11059.2KHz = 11059200Hz

机器周期 = 12 x 时钟周期 =12 x (1/时钟频率) 秒 = 12 / 11059200 秒 = 12 000 000 / 11059200 微秒 = 1.085 微秒

也就是说对于11.0592Mhz的晶振，其机器周期就是1.085微秒

#### 7.4 实际案例

案例：通过单片机设定一个10ms的定时器有如下的部分

符号	含义
TL0(Timer Low0)	定时器0的低8位寄存器
TH0(Timer HIgh0)	定时器0的高8位寄存器
根据上表，可以知道共16位的寄存器可以数2^16次，就是65536次，而每次计数一下，就会耗费1.085微秒，因此当计数超过65535时，定时器寄存器就会爆表，也就是经过之后就会爆表，通常可以理解为经过71ms之后就会爆表。

对于10ms而要，首先可以计算出10ms定时定时器需要数多少次，设需要数x次，则

设定时器的初始值为y，则

将56320转化成16进制数，通过计算可以知道16#DC00，因此TH = DC ;TL = 00

也就是说需要计数9612次，就可以认为经过了10ms，这时，我们可以用71ms减去10ms的次数，就可以知道定时开始计数的初始值，这个值就是y值

#### 7.5 小结

单片机定时器的原理就是通过计算出所定时间需要计数的次数x，通过65536减去x，算出定时器所需的初始值，然后将初始值转化成16进制，填入TH与TL寄存器中，然后通过读取定时器溢出标志位，就可以知道定时器的定时状态。



